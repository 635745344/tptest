<script src="/plugin/highchart/highcharts.js"></script>
<script src="/plugin/highchart/exporting.js"></script>
<style>
    .statistics_h2{
        color: #333;
        background-color: #f5f5f5;
        border:1px solid #ddd;
        font-size:14px;
        padding-left:30px;
        padding-bottom: 0;
        padding-top: 0;
        line-height: 40px;
        height: 40px;
    }
    .statistics_box{
        width:100%;
        height:100%;
        border:1px solid #ddd;
    }
    .box-content{
        margin-top: 0;
        background:#fff;
        padding-right: 20px;
        padding-left: 20px;

    }
    .box{
        border-top:0;
    }
    h2.title{
        line-height:42px;
        text-align:center;
        font-size:36px;
        padding:10px;
    }
</style>
<div class="content_box clearfix animated fadeIn">
    <h2 class="statistics_h2">调查统计</h2>
    <div class="statistics_box clearfix">
        <div class="box-content">
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span12">
                        <div class="row-fluid search-forms search-default">
                            <form class="form-search" action="#" novalidate="novalidate">
                                <div class="chat-form">
                                    <h2 class="title"></h2>
                                    <div class="input-cont">
                                        <span class=""> 统计</span>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="row-fluid">
                 <div class="span6">
                 </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(function(){

        //饼图公共类
        function charts(id,date,text){
            $(id).highcharts({
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false
                },
                title: {
                    text: text
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            color: '#000000',
                            connectorColor: '#000000',
                            format: '<b>{point.name}</b>: {point.percentage:.1f} %'
                        }
                    }
                },
                series: [{
                    type: 'pie',
                    name: '占比',
                    data: date
                }]
            });
        }

        //获取url参数
        function getQueryString(name) {
            var after = window.location.hash.split("?")[1];
            if(after)
            {
                var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
                var r = after.match(reg);
                if(r != null)
                {
                    return  decodeURIComponent(r[2]);
                }
                else
                {
                    return null;
                }
            }
        }

        $(document).ready(function() {
            inti(10, 1);
            function inti(limits, page) {
                $.ajax({
                    type: 'get',
                    data: {"id": getQueryString("id")},
                    url: "/admin/question/statistics",
                    success: function(msg) {
                        console.log(msg);
                        $("h2.title").text(msg.title);
                        var indexs=0;
                        var text="";//标题
                        var colors=["blue","red","yellow","green","purple","light-grey"];
                        var i=0;

                        for(var item in msg.data){
                           /* if(msg.data[item].type==3||msg.data[item].type==4){
                                continue;
                            }else{*/


                            i++;
                            var dates=[];
                            $(".span6").append("<div class='portlet box "+colors[Math.floor(Math.random() * 5 + 1)]+"'><div class='portlet-title'><div class='caption'>"+msg.data[item].title+"</div></div><div class='portlet-body'><div id='pie_chart_"+i+"' class='chart'></div></div></div>");
                            /*indexs++;
                            if(indexs==2){
                                indexs=0;
                            }*/


                            //计算总个数
                            var count=0;
                            if(msg.data[item].option==undefined){
                                count=msg.data[item].count;

                            }else {
                                $.each(msg.data[item].option, function(index, content){
                                    count+=parseInt(content.count);
                                });
                                $.each(msg.data[item].option, function(index, content){
                                    var da={};
                                    da.name=content.title+"   "+content.count+"条数据";
                                    da.y=(parseInt(content.count)/count).toFixed(2)=="NaN"?0:parseFloat((parseInt(content.count)/count).toFixed(2));
                                    dates.push(da);
                                });
                            }
                            if( count==0){
                                text="暂无数据";
                                dates=[];
                            }else{

                                text="共"+count+"条数据";
                                if(msg.data[item].option==undefined){
                                    text+="（问答类型题目）";
                                }
                            }

                            charts($("#pie_chart_"+i),dates,text);
                        }
                        /*}*/
                    },
                    dataType: "json",
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                        //errormsg(XMLHttpRequest, textStatus, errorThrown);
                    }
                });
            }
        });



    })
</script>