<style>
    .content_h2{
        border:none;
        font-weight:400;
    }
    .content_box_left{
        width:9%;
        float:left;
        background-color:#fff;
        border-top:2px solid #00A65A;
    }
    .content_box_left ul{
        width:100%;
        min-height:400px;
    }
    .content_box_left ul li{
        line-height:38px;
        padding-left:15px;
        cursor:pointer;
    }
    .content_box_left ul li.adminAtor{
        background-color:#F7F7F7;
    }
    #classifyTable{
        position:relative;
        width:100%;
        height:auto;
        left:0;
        top:-2px;
    }
    #operation{
        position:absolute;
        top:2px;
        left:50px;
        width:80%;
        height:38px;
        z-index:100;
    }
    table{
        border:none;
    }
    #operation td{
        float:left;
        padding:5px 15px;
        margin:4px 10px;
        background:#F4F4F4;
        border:1px solid #bbb;
        border-radius:4px;
        cursor:pointer;
    }
    #operation td:hover{
        color:#009688;
    }
    .layui-table-cell{
        height:100%;
    }
    #layer-form{
        width:100%;
        height:auto;
        background-color:#ffff;
        border:1px solid #DADEE2;
        padding:10px 0 20px 0;
    }
    #layer-form .layui-form .layui-input-block{
        width:98%;
        margin:10px auto 0;
        padding-left:5px;
    }
    .layui-input-block span{
        -webkit-touch-callout: none; /* iOS Safari */

        -webkit-user-select: none; /* Chrome/Safari/Opera */

        -khtml-user-select: none; /* Konqueror */

        -moz-user-select: none; /* Firefox */

        -ms-user-select: none; /* Internet Explorer/Edge */

        user-select: none; /* Non-prefixed version, currently

        not supported by any browser */
    }
    #layer-form .layui-form input{
        margin-right:5px;
        float:left;
    }
    #layer-form .layui-form-item{
        width:75%;
        margin:10px auto 0;
    }
    #layer-form .layui-form-item button{
        border:none;
        background:#00C0EF;
        padding:5px 30px;
        color:#fff;
        border-radius:5px;
        float:left;
    }
    #layer-form .layui-form-item button.cancal{
        float:right;
        background:#CCCCCC;
    }
    .layui-form-label{
        padding:0;
        text-align:center;
        width:90px;
    }
    .layui-form-label span{
        font-size:18px;
    }
    .layui-form-label .admin{
        color:#73B9FF;
    }
    .layui-form-label .retail{
        color:#FF7373;
    }
    .layui-form-label .mainten{
        color:#FFA64D;
    }
    .layui-form-label i{
        color:#BCC5C8;
        margin-right:6px;
        font-size:18px;
        cursor:pointer;
    }
    .layui-table, .layui-table-view{
        margin:0;
    }
    @font-face {font-family: "iconfont";
        src: url('iconfont.eot?t=1524016064514'); /* IE9*/
        src: url('iconfont.eot?t=1524016064514#iefix') format('embedded-opentype'), /* IE6-IE8 */
        url('data:application/x-font-woff;charset=utf-8;base64,d09GRgABAAAAAAWUAAsAAAAACDwAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABHU1VCAAABCAAAADMAAABCsP6z7U9TLzIAAAE8AAAARAAAAFZW7klJY21hcAAAAYAAAABnAAABnNBybsRnbHlmAAAB6AAAAasAAAH4i70IuGhlYWQAAAOUAAAALwAAADYRGM19aGhlYQAAA8QAAAAcAAAAJAfeA4VobXR4AAAD4AAAABAAAAAQD+kAAGxvY2EAAAPwAAAACgAAAAoBcgCwbWF4cAAAA/wAAAAfAAAAIAETAF1uYW1lAAAEHAAAAUUAAAJtPlT+fXBvc3QAAAVkAAAALwAAAEgG2ECFeJxjYGRgYOBikGPQYWB0cfMJYeBgYGGAAJAMY05meiJQDMoDyrGAaQ4gZoOIAgCKIwNPAHicY2Bk/sU4gYGVgYOpk+kMAwNDP4RmfM1gxMjBwMDEwMrMgBUEpLmmMDgwVDyPZW7438AQw9zA0AAUZgTJAQAq/QzMeJzFkMEJwCAMRX+MLVI6So+l24jQU0dwYh3DJtGLE/jlmeQTjATABoCFS/AAfSCoXnHJfMZhvscjdZDjJOaSamxtylRkHcEypy/TjmWidaNnnXbfo9J954F8saSO7rXGDvgHAKcSZwB4nFWQz27TQBDG99v1ehM3sfH/xGniOKHZ0gRLmJBQVSQXWslVD0iISkFRVR4Arr1w8KUSBw48A0JC4pxTVfESPAGC17DLUi50tdpvZr/faDRDOCE3P9k1axGX7JJH5Dl5QQj0MQYm7SKR05SO4SfcDz2TyaFMxHCQsmcIB7oXZLPpKNSFbsFED4+TbCZTKvFkuqAHyIIu0O5EL52dbYd9gtGSvcvqmH6GHw+3rcXDKp8svazv1i4ajtN2nI81nfMapZpl4m0Y1Hnd0Ksv3Ir86/gBjdFoy+hk1ex3nDcfpu+6O2EdKAq4nb75dWlHtrrvo8B12uJes9aKmsP7Hi5+b7XcRnf0i6hD1ayFRlhBLBITwpMU0l5gnvQQ2ibUEMJWYaK+bGWx1+VJvgbWOb06XFGsSzbZB/Yn9EopP5gUf63NP6Q8Olyx78osj3bnt9BGQXd7jtVmk7tNGPSBRIrpbImFWlmMIJtjlin12KvyND+n9Dyn3271aXUqPHFDNM61Pc0QBtuoHGfq2ROsUOD/BdWPaqTrqLMtBUrGObtU6ZkQY8MnfwAJdVLPAHicY2BkYGAA4i3Pxb3i+W2+MnCzMIDAtT9HDiDo/w0sDMwNQC4HAxNIFABeVQxpAHicY2BkYGBu+N/AEMPCAAJAkpEBFbAAAEcKAm0EAAAAA+kAAAQAAAAEAAAAAAAAAAB2ALAA/AAAeJxjYGRgYGBhCGRgZQABJiDmAkIGhv9gPgMAERIBcQB4nGWPTU7DMBCFX/oHpBKqqGCH5AViASj9EatuWFRq911036ZOmyqJI8et1ANwHo7ACTgC3IA78EgnmzaWx9+8eWNPANzgBx6O3y33kT1cMjtyDRe4F65TfxBukF+Em2jjVbhF/U3YxzOmwm10YXmD17hi9oR3YQ8dfAjXcI1P4Tr1L+EG+Vu4iTv8CrfQ8erCPuZeV7iNRy/2x1YvnF6p5UHFockikzm/gple75KFrdLqnGtbxCZTg6BfSVOdaVvdU+zXQ+ciFVmTqgmrOkmMyq3Z6tAFG+fyUa8XiR6EJuVYY/62xgKOcQWFJQ6MMUIYZIjK6Og7VWb0r7FDwl57Vj3N53RbFNT/c4UBAvTPXFO6stJ5Ok+BPV8bUnV0K27LnpQ0kV7NSRKyQl7WtlRC6gE2ZVeOEXpc0Yk/KGdI/wAJWm7IAAAAeJxjYGKAAC4G7ICFkYmRmZGFkZWBsYKnPDWzojQxryojPy+duxLBZmAAAKW3Cp4A') format('woff'),
        url('iconfont.ttf?t=1524016064514') format('truetype'), /* chrome, firefox, opera, Safari, Android, iOS 4.2+*/
        url('iconfont.svg?t=1524016064514#iconfont') format('svg'); /* iOS 4.1- */
    }

    .iconfont {
        font-family:"iconfont" !important;
        font-size:16px;
        font-style:normal;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .icon-weixuanzhong:before { content: "\e65f"; }

    .icon-yixuanzhong:before { content: "\e75d"; }
    .layui-table-page div{
        float:right;
    }
    .content_box_right{
        width:90%;
        position:relative;
        float:left;
        margin-left:1%;
        background:#fff;
        min-height:640px;
        border-top: 2px solid #418BB8;
    }
    table th[data-field='join']{
        height:36px;
        line-height:40px;
    }
    #joinButton{
        position:absolute;
        left:10px;
        top:2px;
        z-index:10;
        padding: 5px 15px;
        background: #F4F4F4;
        border: 1px solid #bbb;
        border-radius: 4px;
        cursor: pointer;
    }
    td[data-field='group_name'] .layui-table-cell{
        overflow:visible ;
    }
    #leftContent li.active{
        background:#F7F7F7;
    }
    #setOriginBox{
        width:240px;
        margin:40px auto;
        display:none;
    }
</style>
<div class="content_box clearfix">
    <h2 class="content_h2">设备分组管理</h2>
    <div class="content_box_left">
        <ul id="leftContent">
            <li  class="allAtor li-item active">全部用户<span></span></li>
        </ul>
    </div>
    <div class="content_box_right">
        <table class="layui-hide" id="status_table" lay-filter="status_table"></table>
        <!--<button id="joinButton">加入分组</button>-->
    </div>
</div>
<div id="setOriginBox">
    <form class="layui-form" action="">
        <select name="interest" lay-filter="selected">
        </select>
    </form>
</div>

<script type="text/html" id="toolbarDemo">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="setGrop" id="setGrop">设置分组</button>
        <button class="layui-btn layui-btn-sm" lay-event="addGrop" id="addGrop">添加分组</button>
    </div>
</script>
<script type="text/html" id="joinContent">
    <form class="layui-form" lay-event="select">
        <select value="{{d.group_id}}" id="select{{d.code}}" lay-filter="select{{d.id}}">

            {{#  layui.each(d.group_list, function(index, item){ }}
            {{#  if(item.id=== d.group_id){ }}
            <option value="{{item.id}}" selected = "selected">{{item.group_name||'未分组'}}</option>
            {{#  } else{ }}
            <option value="{{item.id}}">{{item.group_name||'未分组'}}</option>
            {{#  } }}
            {{#  }); }}
        </select>

    </form>
</script>
<script>
    $(function(){
        //获取左侧列表数据
        var group_list;
      function getLeftData(){
           $.ajax({
                url:"/admin/group/get_group",
                dataType:"json",
               toolbal:'#toolbarDemo',
                success:function(res){
                    var str="",group_list =res.group_list,str2="";
                    $("#leftContent .allAtor span").text('('+res.equipment_count+')');
                    for(var i in group_list){
                        str+= '<li  class="allAtor li-item " group_name="'+group_list[i].id+'">'+group_list[i].group_name+'<span>'+'('+group_list[i].group_count+')'+'</span>'+'</li>'
                    }
                    for(var i in group_list){
                        str2+= '<option value="'+group_list[i].id+'">'+group_list[i].group_name+'</option>'
                    }
                    $("#leftContent").append(str)
                    $("#setOriginBox select").append(str2)
                }
            })
        }
        getLeftData();
        layui.use(['form','table'], function(){
            var table = layui.table;
            var form =layui.form;
            form.render(); //更新全部
            form.render('select'); //刷新select选择框渲染
            table.render({
                elem: '#status_table'
                ,url:'/admin/group/get_group_machine'
                ,cellMinWidth: 80,
                request: {
                    pageName: 'page' //页码的参数名称，默认：page
                    ,limitName: 'limit' //每页数据量的参数名，默认：limit
                },
                toolbar: '#toolbarDemo'
                ,cols: [[
                    {type:'checkbox'}
                    ,{field:'code', title: '设备编号',align:'center'}
                    ,{field:'group_name', minWidth:150, title: '所属分组',align:'center',toolbar:'#joinContent'}
                    ,{field:'groove_good1_g_name', title: '烟仓1',align:'center'}
                    ,{field:'groove_good2_g_name', title: '烟仓2',align:'center'}
                    ,{field:'groove_good3_g_name',  title: '烟仓3',align:'center'}
                    ,{field:'groove_good4_g_name', title: '烟仓4',align:'center'}
                    ,{field:'groove_good5_g_name',  title: '烟仓5',align:'center'}
                    ,{field:'groove_good6_g_name',  title: '烟仓6',align:'center'}
                    ,{field:'groove_good7_g_name', title: '烟仓7',align:'center'}
                ]]
                ,page:{layout:false,groups:5,heme:'#367AB7',first:false
                    ,last:false,prev:'<em>Previous</em>',next:'<em>Next</em>'}
                ,response:{
                    statusName:'status',
                    statusCode:1,
                    dataName:'machine_list'
                },
                height:640,
                method:'post',
                id:'tableId',
                done:function(){
                    //addchange()
                    form.render(); //更新全部
                    form.render('select'); //刷新select选择框渲染
                    $(".layui-table-body.layui-table-main").height("490px");
                }
            });

            // function addchange(){
            //     var parent =$("select[id^=select]");
            //     var str ="";
            //         $.ajax({
            //             url:"/admin/group/get_group",
            //             dataType:"json",
            //             success:function(res){
            //                  group_list =res.group_list;
            //                 for(var i in group_list){
            //                     str+= '<option value="'+group_list[i].id+'">'+group_list[i].group_name+'</option>'
            //                 }
            //                 for(var g=0;g<parent.length;g++) {
            //                     $(parent[g]).append(str).children().first().remove();
            //                 }
            //                 form.render(); //更新全部
            //                 form.render('select'); //刷新select选择框渲染
            //             }
            //
            //         })
            //
            // }
            table.on('tool(status_table)',function(obj){
                var data =obj.data;
                console.log(this)
                var submitData={};
                submitData.eq_id =data.id;
                var filter ="select"+data.id;
                form.on('select('+filter+')', function(data){
                    submitData.group_id =data.value;
                    load("正在提交")
                    $.ajax({
                        url:'/admin/Group/save_group_machine',
                        data:submitData,
                        type:"post",
                        success:function(res){
                                prompt(res.msg,4000)

                        },
                        error:function(err){
                            alert(JSON.stringify(err))
                        }
                    })
                    // AjaxRequest({url:'/admin/Group/save_group_machine',data:submitData,type:"post"},function(res){
                    //     prompt(res.msg,1,4000)
                    // })
                });


            })
            //添加分组
            $(".content_box_right").on("click","#addGrop",function(){
                addGrop()
            })
            //设置分组
            $(".content_box_right").on("click","#setGrop",function(){
                selecttext()
            })

            function reload(data){
                table.reload("tableId",{
                    url:"/admin/group/get_group_machine",page:{curr:1},where:data
                })
            }
            //左侧点击事件
            $("#leftContent").on("click","li",function(){
                if($(this).hasClass("active")){
                    return;
                }else{
                    $(this).addClass("active").siblings().removeClass("active");
                    var id =$(this).attr("group_name")
                    var data ={}
                    data.group_id=id
                    reload(data)
                }
            })
            function selecttext(){
                var checkStatus = table.checkStatus('tableId');
                var data =checkStatus.data;
                var submitData ={};
                var eq_id="";
                if(data.length<=0){
                    layer.msg("请选中要分组的设备信息");
                    return;
                }else{
                    form.on('select(selected)', function(data){
                        submitData.group_id =data.value;
                    });
                    for(var p in data){
                        eq_id=eq_id+data[p].id+",";
                    }
                    submitData.eq_id =eq_id.substring(0,eq_id.length-1);
                    console.log(submitData)
                    layer.open({
                        title: '请选择要添加的分组'
                        ,content: $("#setOriginBox"),type: 1
                        ,area: ['400px', '500px']
                        ,anim: 1 //0-6的动画形式，-1不开启
                        ,closeBtn:0,
                        btn: ['确定','取消'],
                        yes:function(){
                            load("正在提交")
                            $.ajax({
                                url:"/admin/Group/save_group_machine",
                                data:submitData,
                                type:"post",
                                success:function(res){
                                    prompt("提交成功",4000)
                                    console.log(res)
                                }
                            })
                        },
                        btn2:function(){
                            layer.closeAll();
                        },
                    });

                }
            }
        });
        function addGrop(){
            layer.prompt({title: '请输入要添加的分组名，并确认', formType: 0}, function(pass, index){
                layer.close(index);
                $.ajax({
                    url:"/admin/group/add_group",
                    type:"post",
                    data:{group_name:pass},
                    success:function(res){
                        prompt("添加成功",4000)
                    },
                    error:function(err){
                        alert(JSON.stringify(err))
                    }
                })
            });
        }
        function joinOrigan(){
            layer.open({
                title: '请选择要添加的分组'
                ,content: $("#setOriginBox"),type: 1
                ,area: ['400px', '500px']
                ,anim: 1 //0-6的动画形式，-1不开启
                ,closeBtn:0,
                btn: ['确定','取消'],
                yes:function(){

                },
                btn2:function(){
                    layer.closeAll();
                },
            });
        }
        //加载
        function load(text){
            layer.load(3,{
                content:text,
                shade:0.5,
            });

        }
        //提示
        function prompt(text,time){
            layer.open({
                title:false,
                btnAlign:"c",
                content:"<p style='text-align:center;font-size:18px;'>"+text+"</p>",
                time:time||6000,
                shade:0.6,
                end:function(){
                    history.go(0);
                    layer.closeAll();
                }

            })
        }
    })
</script>

