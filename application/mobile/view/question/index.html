<!DOCTYPE html>
<html lang="zh">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <link href="/static/mobile/question/css/Base.css" rel="stylesheet">

    <!--问卷调查样式-->
    <link href="/static/mobile/question/css/Questionnaire.css" rel="stylesheet" />
    <link href="/static/mobile/question/css/ydui.css" rel="stylesheet" />
    <script src="/plugin/jquery/jquery-3.2.1.min.js"></script>
    <script src="/static/mobile/question/js/Base.js?v=2" type="text/javascript"></script>
    <script src="/static/mobile/question/js/ydui.flexible.js"></script>

    <title>问卷调查</title>
    <style>
        /*弹出层*/
        .shadowLayer {
            display: none;
            width: 100%;
            height: 100%;
            position: fixed;
            background-color: #000;
            opacity: .6;
            top: 0;
            left: 0;
            z-index: 100;
        }

        .msgLayer {
            display: none;
            width: 80%;
            padding: 3% 5%;
            position: fixed;
            z-index: 101;
            background: #FEFAD3;
            text-align: center;
            margin: 0px 5%;
            border-radius: 15px;
            box-shadow: 0px 0px 10px #FEFAD3;
            top: 50%;
            left: 0;
        }

        .msgLayer .tit {
            color: #182A1F;
            font-size: 20px;
        }

        .msgLayer .tit span {
            color: #F24B4B;
        }

        .msgLayer img {
            width: 100px;
            margin: 15px 0;
        }

        .msgLayer p {
            margin: 15px 0;
            color: #182A1F;
            font-size: 20px;
        }

        .msgLayer .btn_active {
            width: 45%;
            height: 36px;
            background-color: #FF7153;
            color: #fff;
            font-size: 20px;
            line-height: 32px;
            display: block;
            margin: 0 auto;
            border-radius: 15px;
            border-bottom: #CA352F 4px solid;
            box-sizing: content-box;
        }

        .TitleText {
            font-size: 0.25rem;
        }

        .button-holder-list ul li {
            font-size: 0.25rem;
        }
        .TextContent{
            margin-top:0.1rem;
        }
    </style>

</head>
<body style="overflow:scroll">

<div class="countent border-image">



    <p class="top_title">标题</p>
    <p style="color: #922F22; margin-top: 0.5rem;font-size: 0.25rem;">您好！ 目前正在进行一项关于卷烟的调查活动，希望您能给些意见我们。对于您提供的所有信息，我们都只是作为研究之用，是绝对保密的。现在参加问卷调查，就有机会获得我们的惊喜好礼一份，记得关注我们的服务号动态哦。</p>
    <div id="holder">
        <!--问题列表-->
    </div>
    <!--模版-->
    <div style="display: none" id="temp">


        <!--单选radio 多选multiselect-->
        <div class="button-holder  button-holder-list">
            <p class="TitleText" data-id=""></p>
            <ul></ul>
        </div>
        <!--选项列表-->
        <ul>
            <li>
                <input type="radio" class="regular-radio" />
                <label data-id="" style="cursor: pointer"></label><!--@item.Answer-->
            </li>

        </ul>
        <!--文本题目-->
        <div class="button-holder textcontent">
            <p class="TitleText" data-id=""></p>
            <textarea class="TextContent" rows="5" placeholder="请输入... " name="tex"></textarea>
        </div>

        <!--地址-->
        <div class="button-holder useraddress">
            <p class="TitleText" data-id=""></p>

            <div class="cell-item">
                <div class="cell-left">所在地区：</div>
                <div class="cell-right cell-arrow">
                    <input type="text" class="cell-input qtaddress" placeholder="请选择省市区" readonly="readonly">
                </div>
            </div>
            <input class="TextContent" placeholder="请输入街道 如：XX街XX楼XX号" name="tex" style="width: 100%; height: 0.5rem;background-color:white;border: 1px solid lightgrey;">
        </div>

        <!--文本-->
        <div class="button-holder usertext">
            <p class="TitleText" data-id=""></p>
            <input class="TextContent" placeholder="请输入... " name="tex" style="width: 100%; height: 0.5rem; background-color:white;border: 1px solid lightgrey;">
        </div>

    </div>


</div>

<p style="text-align:center; color:#A93619; clear: both; margin-top:2em;">*本问卷活动每人仅限一次参与机会</p>

<div class="subtn" onclick="sbinfo()">提交</div>
<!--提示框-->
<div id="lightshow" class="div_content">
    <div id="messagebox" class="div_messageshow">
    </div>
    <div class="div_main" style="width:100%; ">

        <div id="surebuttonok" class="div_li" style="float:left; width:35%; margin-left:15% ">
            确 定
        </div>
        <div id="surebuttonno" class="div_li div_li_no"
             style="float:left; width:35%; margin-left:2%;">
            取 消
        </div>

    </div>
</div>
<div id="fadeshow" class="div_overlay"></div>


<!-- 弹出层 -->
<div class="shadowLayer"></div>
<div class="msgLayer">
    <h1 class="tit"></h1>
    <img src="/static/mobile/question/image/cry.png" />
    <p></p>
    <button style="font-size: 20px" class="btn_active"></button>
</div>

<script>
    $("#surebuttonno").click(function () {
        $("#lightshow").css("display", "none");
        $("#fadeshow").css("display", "none");
    });
</script>
</body>
</html>

<script src="/static/mobile/question/js/ydui.citys.js"></script>
<script src="/static/mobile/question/js/ydui.js"></script>
<script src="/static/mobile/question/js/layer_mobile/layer.js"></script>
<script>
    $(document).ready(function () {
        var id =getQueryString("id"),title ='{$title}',question = {$question};
        console.log(question);
       /* $("#questionnaire_name").val(question.title);//问卷标题
        $("#datetimepicker7").val(question.begintime);//开始时间
        $("#datetimepicker8").val(question.endtime);//结束时间*/
        $(".question_list").html("");
        $(".top_title").html(title);
            $.each(question, function (index, item) {
                var list_item = $("#temp>div").eq(0).clone();

                if (item.type == "1") {
                    list_item.addClass("radio");
                } else if (item.type == "2") {
                    list_item.addClass("multiselect");
                } else if (item.type == "3") {
                    list_item = $("#temp>div").eq(1).clone();
                } else if (item.type == "4") {
                    list_item = $("#temp>div").eq(2).clone();
                } else if (item.type == "5") {
                    list_item = $("#temp>div").eq(3).clone();
                }

                list_item.find(".TitleText").attr("data-id", item.id);
                if (item.type == "1" || item.type == "2") {
                    $.each(JSON.parse(item.option), function (indexs, itemsss) {
                        var qlis = $("#temp>ul>li").clone();
                        qlis.find("label").attr("data-id", itemsss.id);
                        if (itemsss.title.length > 3) {
                            qlis.css("clear", "both");
                            qlis.css("width", "100%");
                        }
                        qlis.append(itemsss.title);
                        list_item.find("ul").append(qlis);
                    })
                }
                list_item.find(".TitleText").html(index + 1 + "、" + item.title);//题目标题
                $("#holder").append(list_item);

            });

            var $target = $('#holder .qtaddress');
            $target.citySelect({
                provance: "",
                city: "",
                area: ""
            });
            $target.on('click', function (event) {
                event.stopPropagation();
                $target.citySelect('open');
            });

            $target.on('done.ydui.cityselect', function (ret) {
                $(this).val(ret.provance + ' ' + ret.city + ' ' + ret.area);
            });
        /*$.ajax({
            type: 'post',
            url: "/Shop/Questionnaire/verify",
            data: { id: getQueryString("id") },
            dataType: 'json',
            async: false,
            success: function (e) {
                console.log(e);
                if (e.status == 1) {
                    window.location = "/Shop/Questionnaire/tip?id=1";
                } else if (e.status == 2) {
                    window.location = "/Shop/Questionnaire/tip?id=2";
                } else if (e.status == 3) {
                    window.location = "/Shop/Questionnaire/tip?id=3";
                }

            }
        });*/
        //加载问卷信息
        /*$.ajax({
            type: 'POST',
            url: "/Shop/Questionnaire/wjdata",
            data: { "id": getQueryString("id") },
            dataType: "json",
            success: function (msg) {
                 $("#questionnaire_name").val(msg.data.title);//问卷标题
                 $("#datetimepicker7").val(msg.data.begintime);//开始时间
                 $("#datetimepicker8").val(msg.data.endtime);//结束时间
                 $(".question_list").html("");

                $(".top_title").html(msg.info.title);
                $.each(msg.info.items, function (index, item) {
                    var list_item = $("#temp>div").eq(0).clone();

                    if (item.type == "1") {
                        list_item.addClass("radio");
                    } else if (item.type == "2") {
                        list_item.addClass("multiselect");
                    } else if (item.type == "3") {
                        list_item = $("#temp>div").eq(1).clone();
                    } else if (item.type == "4") {
                        list_item = $("#temp>div").eq(2).clone();
                    } else if (item.type == "5") {
                        list_item = $("#temp>div").eq(3).clone();
                    }

                    list_item.find(".TitleText").attr("data-id", item.id);
                    if (item.type == "1" || item.type == "2") {
                        $.each(item.answer_name, function (indexs, itemsss) {
                            var qlis = $("#temp>ul>li").clone();
                            qlis.find("label").attr("data-id", itemsss.id);
                            if (itemsss.answer_name.length > 3) {
                                qlis.css("clear", "both");
                                qlis.css("width", "100%");
                            }
                            qlis.append(itemsss.answer_name);
                            list_item.find("ul").append(qlis);
                        })
                    }
                    list_item.find(".TitleText").html(index + 1 + "、" + item.title);//题目标题
                    $("#holder").append(list_item);

                });

                var $target = $('#holder .qtaddress');
                $target.citySelect({
                    provance: "",
                    city: "",
                    area: ""
                });
                $target.on('click', function (event) {
                    event.stopPropagation();
                    $target.citySelect('open');
                });

                $target.on('done.ydui.cityselect', function (ret) {
                    $(this).val(ret.provance + ' ' + ret.city + ' ' + ret.area);
                });
            },

            error: function (XMLHttpRequest, textStatus, errorThrown) {

            }
        });*/

        //单选按钮
        $(document).on("click", ".radio li", function () {
            $(this).siblings().children("label").removeClass("checks");
            $(this).children("label").addClass("checks");
        });
        //多选按钮
        $(document).on("click", ".multiselect li", function () {
            if ($(this).children("label").hasClass("checks")) {
                $(this).children("label").removeClass("checks");
            } else {
                $(this).children("label").addClass("checks");
            }
        });


    });

    //获取url参数
    //获取url参数
    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if(!r){
            return;
        }
        return r[2];
    }

    //提交投票结果
    function sbinfo() {
        //验证用户是否都选择了答案
        for (var h = 0; h < $("#holder .button-holder-list").length; h++) {
            if ($("#holder .button-holder-list").eq(h).find(".checks").length == 0) {
                ui.opendivshow('<span style=color:white;>请填写完整答案！</span>');
                return;
            }
        }

        /*//验证用户是否都填写了答案
        for (var h = 0; h < $("#holder .textcontent").length; h++) {
            if ($("#holder .textcontent").eq(h).find(".TextContent").val() == "") {
                ui.opendivshow('<span style=color:white;>请填写完整答案！</span>');
                return;
            }
        }*/
        for (var h = 0; h < $("#holder .useraddress").length; h++) {
            if ($("#holder .useraddress").eq(h).find(".qtaddress").val() == "" || $("#holder .useraddress").eq(h).find(".TextContent").val() == "") {
                ui.opendivshow('<span style=color:white;>请填写完整答案！</span>');
                return;
            }
        }
        for (var h = 0; h < $("#holder .usertext").length; h++) {
            if ($("#holder .usertext").eq(h).find(".TextContent").val() == "") {
                ui.opendivshow('<span style=color:white;>请填写完整答案！</span>');
                return;
            }
        }

        var data = {};

        data.id=getQueryString("id");
        var Datas = [];

        //保存选择题选择数据
        //单选和多选
        if($(".button-holder-list").hasClass("radio")){
            $.each($(".radio"), function (index, item) {
                console.log($(item).find(".checks"));
                Datas.push({
                    "id": $(item).children("p.TitleText").attr("data-id"),
                    "option_id": $(item).find(".checks").attr("data-id"),
                    "remark":""
                });
            });
        }
        if($(".button-holder-list").hasClass("multiselect")){
            var option_id ="";
            /*for(var k=0,len=$(".button-holder-list .multiselect").length;k<len;k++){
                option_id+=$($(".button-holder-list .checks")[k]).attr("data-id")+",";
            }
            option_id =option_id.substring(0,option_id.length-1);
            Datas.push({
                "id": $($(".button-holder-list .checks")[0]).parents(".button-holder").children("p").attr("data-id"),
                "option_id": option_id,
                "remark":""
            });*/
            $.each($(".multiselect"), function (index, item) {
                for(var k=0,len=$(item).find(".checks").length;k<len;k++){
                    option_id+=$($(item).find(".checks")[k]).attr("data-id")+",";
                }
                option_id=option_id.substring(0,option_id.length-1);
                Datas.push({
                    "id": $(item).find("p.TitleText").attr("data-id"),
                    "option_id":option_id,
                    "remark":""
                });

               /* Datas.push({
                    "option_id":option_id
                })*/
            });
        }

       /* var option_id="";
       for(var k=0,len=$(".checks").length;k<len;k++){
           option_id+=$(item).attr("data-id")+",";
       }*/

        //保存长文本题目数据
        $.each($("#holder textarea"), function (index, item) {
            Datas.push({
                "id": $(item).parents(".button-holder").children("p").attr("data-id"),
                "option_id":0,
                "remark": $(item).val()
            });
        });

        //保存地址
        $.each($("#holder .useraddress"), function (index, item) {
            Datas.push({
                "id": $(item).children("p").attr("data-id"),
                "option_id":0,
                /*"remark": $(item).find(".qtaddress").val().replace(new RegExp(" ", "gm"), '/r/n') + "/r/n" + $(item).find(".TextContent").val()*/
                "remark": $(item).find(".qtaddress").val()+ $(item).find(".TextContent").val()
            });
        });
        //保存段短文本
        $.each($("#holder .usertext"), function (index, item) {
            Datas.push({
                "id": $(item).children("p").attr("data-id"),
                "option_id":0,
                "remark": $(item).find(".TextContent").val()
            });
        });

        data.answer = JSON.stringify(Datas);
        console.log(data);
        layer.open({
            shadeClose: false,
            type: 2,
            content: '正在提交...'
        });

        $.ajax({
            type: 'post',
            url: "/mobile/question/submit",
            data: data,
            dataType: 'json',
            success: function (e) {
                layer.closeAll();
                layer.open({
                    shadeClose: false,
                    content: '提交成功'
                    , btn: ['关闭']
                    ,end:function(){
                        window.location.href="/mobile/question/resultView?msg="+"提交成功!注意查看得奖信息"
                    }
                   /* , yes: function (index) {

                        WeixinJSBridge.call('closeWindow');
                    }*/
                });
            }
        });



    }

    //答案图片&材料
    function getImg(num) {
        switch (num) {
            case "1":
                return { "img": "pork", "text": "猪肉" };
            case "4":
                return { "img": "rice", "text": "米饭" };
            case "3":
                return { "img": "egg", "text": "蛋黄" };
            case "2":
                return { "img": "leaf", "text": "粽叶" };
        }
    }
</script>
