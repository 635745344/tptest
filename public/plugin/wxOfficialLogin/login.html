<!DOCTYPE html>
<html>
<head>
	<title>微信登录</title>
	<meta charset="utf-8">
	<link href="https://res.wx.qq.com/connect/zh_CN/htmledition/images/favicon3696b4.ico" rel="Shortcut Icon">
	<style type="text/css">
		.impowerBox,.impowerBox .status_icon,.impowerBox .status_txt{display:inline-block;vertical-align:middle}a{outline:0}h1,h2,h3,h4,h5,h6,p{margin:0;font-weight:400}a img,fieldset{border:0}body{font-family:"Microsoft Yahei";color:#fff;background:0 0}.impowerBox{line-height:1.6;position:relative;width:100%;z-index:1;text-align:center}.impowerBox .title{text-align:center;font-size:20px}.impowerBox .qrcode{width:280px;margin-top:15px;border:1px solid #E2E2E2}.impowerBox .info{width:280px;margin:0 auto}.impowerBox .status{padding:7px 14px;text-align:left}.impowerBox .status.normal{margin-top:15px;background-color:#232323;border-radius:100px;-moz-border-radius:100px;-webkit-border-radius:100px;box-shadow:inset 0 5px 10px -5px #191919,0 1px 0 0 #444;-moz-box-shadow:inset 0 5px 10px -5px #191919,0 1px 0 0 #444;-webkit-box-shadow:inset 0 5px 10px -5px #191919,0 1px 0 0 #444}.impowerBox .status.status_browser{text-align:center}.impowerBox .status p{font-size:13px}.impowerBox .status_icon{margin-right:5px}.impowerBox .status_txt p{top:-2px;position:relative;margin:0}.impowerBox .icon38_msg{display:inline-block;width:38px;height:38px}.impowerBox .icon38_msg.succ{background:url(../images/icon_popup3696b4.png)0 -46px no-repeat}.impowerBox .icon38_msg.warn{background:url(../images/icon_popup3696b4.png)0 -87px no-repeat}
	</style>
	<script src="https://cdn.staticfile.org/jquery/1.11.3/jquery.min.js"></script>
	<script src="https://cdn.staticfile.org/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
</head>
<body>
<div class="main impowerBox">
	<div class="loginPanel normalPanel">
		<div class="title">微信登录</div>
		<div class="waiting panelContent">
			<div id="qrcode" class="wrp_code"></div>
			<div class="info">
				<div class="status status_browser js_status" id="wx_default_tip">
					<p>请使用微信扫描二维码登录</p>
					<p id="accountName"></p>
				</div>
				<div class="status status_succ js_status" style="display:none" id="wx_after_scan">
					<i class="status_icon icon38_msg succ"></i>
					<div class="status_txt">
						<h4>扫描成功</h4>
						<p>请在微信中点击确认即可登录</p>
					</div>
				</div>
				<div class="status status_fail js_status" style="display:none" id="wx_after_cancel">
					<i class="status_icon icon38_msg warn"></i>
					<div class="status_txt">
						<h4>您已取消此次登录</h4>
						<p>您可再次扫描登录，或关闭窗口</p>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
</body>
</html>

<script>
    $(function (){
        //微信自带js-start
        var c = window.top != window;
        if (c) {
            var d = "";
            "white" != d && (document.body.style.color = "#373737")
        } else {
            document.getElementsByClassName || (document.getElementsByClassName = function(a) {
                for (var b = [], c = new RegExp("(^| )" + a + "( |$)"), d = document.getElementsByTagName("*"), e = 0, f = d.length; f > e; e++) c.test(d[e].className) && b.push(d[e]);
                return b
            }),
                document.body.style.backgroundColor = "#333333",
                document.body.style.padding = "50px";
            for (var e = document.getElementsByClassName("status"), f = 0, g = e.length; g > f; ++f) {
                var h = e[f];
                h.className = h.className + " normal"
            }
        }
        var i = "";
        if (i) {
            var j = document.createElement("link");
            j.rel = "stylesheet",
                j.href = i.replace(new RegExp("javascript:", "gi"), ""),
                document.getElementsByTagName("head")[0].appendChild(j)
        }

        //微信自带js-end

        //请求服务地址
        var scene_id='';
        //获取所需信息
        function getLoginInfo()
        {
            $.get('/wx/login/officialLoginQR',{ r:Math.random() },function (data){
                if(data.status==1){
                    $('#qrcode').qrcode({
                        render: "canvas",
                        text: data.url
                    });
                    $('#qrcode').find('canvas').prop('class','qrcode lightBorder').css('width','282px').css('height','282px');

                    $('#accountName').html('“'+data.account+'”');
                    scene_id=data.scene_id;
                    islogin();
                }else{
                    alert(data.info);
                }
            },'json');
        }
        //判断是否登录
		function  islogin()
		{
            setTimeout(function () {
                if(scene_id!='')
                {
                    $.get('/wx/login/isLogin',{ 'r':Math.random(),'scene_id':scene_id },function (data){
                        if(data.status==1){
                            window.location.href=getParam('backUrl')+'?data='+data.data;
                        }if(data.status==-1){
                            alert(data.info);
                        }
                        islogin();
                    },'json');
                }
            },1500);
        }

        // 获取指定的URL参数值
        function getParam(paramName) {
            paramValue = "", isFound = !1;
            if (this.location.search.indexOf("?") == 0 && this.location.search.indexOf("=") > 1) {
                arrSource = unescape(this.location.search).substring(1, this.location.search.length).split("&"), i = 0;
                while (i < arrSource.length && !isFound) arrSource[i].indexOf("=") > 0 && arrSource[i].split("=")[0].toLowerCase() == paramName.toLowerCase() && (paramValue = arrSource[i].split("=")[1], isFound = !0), i++
            }
            return paramValue == "" && (paramValue = null), paramValue
        }
        //获取所需信息
        getLoginInfo();
    })
</script>
